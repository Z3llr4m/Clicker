<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cookie Clicker Deluxe</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    :root {
      --primary-color: #ffcc66;
      --secondary-color: #4CAF50;
      --danger-color: #ff6b6b;
      --prestige-color: #9c27b0;
      --background-dark: #1e1e1e;
      --background-medium: #2d2d2d;
      --background-light: #333;
      --text-color: #fff;
      --text-secondary: #ccc;
      --border-radius: 12px;
      --transition-speed: 0.3s;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--background-dark) 0%, var(--background-medium) 100%);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Header */
    header {
      padding: 12px 15px;
      background: var(--background-medium);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      flex-shrink: 0;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 20px;
      font-weight: bold;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition-speed);
    }

    .icon-btn:active {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Stats */
    #stats-container {
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: var(--background-light);
      border-bottom: 1px solid #444;
      flex-shrink: 0;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      font-size: 14px;
    }

    .stat-icon {
      font-size: 18px;
    }

    .stat-value {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }

    /* Main content with scrolling */
    #main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Cookie section */
    #cookie-section {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 280px;
      background: linear-gradient(135deg, #87CEEB 0%, #ADD8E6 100%);
      margin: 10px;
      border-radius: var(--border-radius);
      position: relative;
      flex-shrink: 0;
    }

    .milk-effect {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(173, 216, 230, 0.05) 70%, transparent 100%);
      border-radius: var(--border-radius);
      pointer-events: none;
      z-index: 1;
    }

    .milk-bubble {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: floatBubble 8s infinite ease-in-out;
    }

    @keyframes floatBubble {
      0%, 100% { transform: translateY(0) scale(1); opacity: 0.7; }
      50% { transform: translateY(-20px) scale(1.1); opacity: 0.9; }
    }

    .cookie {
      font-size: 120px;
      cursor: pointer;
      transition: transform 0.1s;
      z-index: 2;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .cookie:active {
      transform: scale(0.9);
    }

    .cookie.shake {
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }

    .multiplier-display {
      position: absolute;
      bottom: 70px;
      background: rgba(0, 0, 0, 0.7);
      color: var(--primary-color);
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 3;
    }

    .prestige-button {
      background: linear-gradient(135deg, var(--prestige-color) 0%, #7b1fa2 100%);
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      border: none;
      color: white;
      margin-top: 15px;
      z-index: 2;
      cursor: pointer;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .prestige-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .prestige-button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    /* Tabs */
    .tab-buttons {
      display: flex;
      background: var(--background-light);
      border-bottom: 1px solid #444;
      flex-shrink: 0;
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      background: var(--background-medium);
      border: none;
      border-right: 1px solid #444;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
      min-height: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background var(--transition-speed);
    }

    .tab-btn.active {
      background: var(--background-light);
      border-bottom: 3px solid var(--primary-color);
    }

    .tab-emoji {
      font-size: 18px;
    }

    .tab-text {
      font-size: 12px;
    }

    /* Tab content */
    .tab-content {
      display: none;
      padding: 15px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab-content.active {
      display: block;
    }

    .tab-title {
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 20px;
    }

    /* Buildings and Upgrades */
    .building-item, .upgrade-item, .prestige-upgrade-item {
      background: var(--background-light);
      margin-bottom: 12px;
      padding: 15px;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary-color);
      transition: transform var(--transition-speed);
    }

    .prestige-upgrade-item {
      border-left: 4px solid var(--prestige-color);
    }

    .building-item:active, .upgrade-item:active, .prestige-upgrade-item:active {
      transform: scale(0.98);
    }

    .building-header, .upgrade-header, .prestige-upgrade-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .building-emoji, .upgrade-emoji, .prestige-upgrade-emoji {
      font-size: 28px;
      margin-right: 15px;
      min-width: 35px;
      text-align: center;
    }

    .building-info, .upgrade-info, .prestige-upgrade-info {
      flex: 1;
    }

    .building-name, .upgrade-name, .prestige-upgrade-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .building-desc, .upgrade-desc, .prestige-upgrade-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .building-stats, .upgrade-stats, .prestige-upgrade-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #444 0%, #333 100%);
      color: white;
      border: none;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      min-height: 44px;
      transition: transform var(--transition-speed), opacity var(--transition-speed);
    }

    .prestige-upgrade-btn {
      background: linear-gradient(135deg, var(--prestige-color) 0%, #7b1fa2 100%);
    }

    button:active:not(:disabled) {
      transform: scale(0.98);
    }

    button:disabled {
      background: #222;
      color: #777;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* Golden Cookie */
    .golden-cookie {
      position: fixed;
      font-size: 40px;
      cursor: pointer;
      z-index: 1000;
      animation: float 3s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
      transition: transform 0.2s;
    }

    .golden-cookie:active {
      transform: scale(1.2);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes glow {
      from { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
      to { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.9)); }
    }

    /* Floating Text */
    .floating-text {
      position: fixed;
      color: var(--primary-color);
      font-weight: bold;
      pointer-events: none;
      z-index: 1001;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      animation: floatUp 1.5s ease-out forwards;
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) scale(1.2);
      }
    }

    /* Animations */
    @keyframes frenzyPulse {
      0%, 100% { 
        text-shadow: 0 0 20px rgba(255, 204, 102, 0.5);
        transform: scale(1);
      }
      50% { 
        text-shadow: 0 0 30px rgba(255, 50, 50, 0.8);
        transform: scale(1.05);
      }
    }

    .frenzy-active {
      animation: frenzyPulse 0.5s infinite;
    }

    /* Save Notification */
    .save-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--secondary-color);
      padding: 12px 18px;
      border-radius: var(--border-radius);
      opacity: 0;
      transition: opacity var(--transition-speed);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Achievements */
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .achievement {
      background: var(--background-light);
      padding: 15px;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary-color);
      transition: transform var(--transition-speed);
    }

    .achievement.locked {
      opacity: 0.6;
      border-left: 4px solid #555;
    }

    .achievement-icon {
      font-size: 24px;
      margin-right: 12px;
      float: left;
    }

    .achievement-info {
      overflow: hidden;
    }

    .achievement-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .achievement-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .achievement-status {
      font-size: 12px;
      font-style: italic;
    }

    /* Mini-games */
    .minigame-container {
      background: var(--background-light);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
    }

    .minigame-button {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    }

    .lottery-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      text-align: center;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--secondary-color);
      color: white;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      z-index: 1000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
    }

    @keyframes slideIn {
      from { transform: translate(-50%, -100px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--background-medium);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: var(--primary-color);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #444;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      min-width: 100px;
    }

    .modal-btn.confirm {
      background: var(--secondary-color);
      color: white;
    }

    .modal-btn.cancel {
      background: #666;
      color: white;
    }

    .modal-btn.danger {
      background: var(--danger-color);
      color: white;
    }

    .setting-group {
      margin-bottom: 20px;
    }

    .setting-group h3 {
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .settings-btn {
      width: 100%;
      margin-bottom: 8px;
      text-align: left;
    }

    .switch {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: relative;
      width: 50px;
      height: 24px;
      background: #666;
      border-radius: 24px;
      margin-right: 10px;
      transition: background var(--transition-speed);
    }

    .slider:before {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform var(--transition-speed);
    }

    input:checked + .slider {
      background: var(--secondary-color);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .switch-label {
      font-size: 16px;
    }

    .prestige-rewards {
      margin-top: 15px;
    }

    .prestige-rewards h3 {
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .highlight {
      color: var(--primary-color);
      font-weight: bold;
    }

    .offline-notification {
      background: var(--prestige-color);
    }

    /* Responsive */
    @media (max-height: 700px) {
      .cookie {
        font-size: 100px;
      }
      #cookie-section {
        min-height: 220px;
        padding: 15px;
      }
    }

    @media (max-height: 600px) {
      .cookie {
        font-size: 80px;
      }
      #cookie-section {
        min-height: 200px;
        padding: 10px;
      }
      .multiplier-display {
        bottom: 60px;
      }
    }

    @media (max-width: 400px) {
      .tab-text {
        display: none;
      }
      .tab-btn {
        padding: 10px 5px;
      }
    }

    /* Loading animation */
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üç™ Cookie Clicker Deluxe</h1>
      <div class="header-buttons">
        <button id="settings-btn" class="icon-btn">‚öôÔ∏è</button>
        <button id="save-btn" class="icon-btn">üíæ</button>
        <button id="load-btn" class="icon-btn">üìÇ</button>
      </div>
    </div>
  </header>

  <div id="stats-container">
    <div class="stat">
      <span class="stat-icon">üç™</span>
      <span id="cookies" class="stat-value">0</span>
    </div>
    <div class="stat">
      <span class="stat-icon">‚ö°</span>
      <span id="cps" class="stat-value">0</span>
    </div>
    <div class="stat">
      <span class="stat-icon">üí∞</span>
      <span id="heavenly-chips" class="stat-value">0</span>
    </div>
    <div class="stat">
      <span class="stat-icon">‚≠ê</span>
      <span id="prestige-points" class="stat-value">0</span>
    </div>
  </div>

  <div id="main-content">
    <!-- Cookie Section -->
    <div id="cookie-section">
      <div class="milk-effect"></div>
      <div id="cookie" class="cookie">üç™</div>
      <div id="cookie-multiplier" class="multiplier-display">x1</div>
      <button id="prestige-btn" class="prestige-button">Prestige (0)</button>
    </div>

    <!-- Tabs -->
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="buildings">
        <span class="tab-emoji">üèóÔ∏è</span>
        <span class="tab-text">Buildings</span>
      </button>
      <button class="tab-btn" data-tab="upgrades">
        <span class="tab-emoji">‚ö°</span>
        <span class="tab-text">Upgrades</span>
      </button>
      <button class="tab-btn" data-tab="prestige-upgrades">
        <span class="tab-emoji">‚≠ê</span>
        <span class="tab-text">Prestige</span>
      </button>
      <button class="tab-btn" data-tab="achievements">
        <span class="tab-emoji">üèÜ</span>
        <span class="tab-text">Achievements</span>
      </button>
      <button class="tab-btn" data-tab="stats">
        <span class="tab-emoji">üìä</span>
        <span class="tab-text">Stats</span>
      </button>
    </div>

    <!-- Tab Contents -->
    <div id="buildings" class="tab-content active"></div>
    
    <div id="upgrades" class="tab-content"></div>
    
    <div id="prestige-upgrades" class="tab-content">
      <h3 class="tab-title">‚≠ê Prestige Upgrades</h3>
      <div id="prestige-upgrades-list"></div>
    </div>
    
    <div id="achievements" class="tab-content">
      <h3 class="tab-title">üèÜ Achievements</h3>
      <div id="achievements-list" class="achievements-grid"></div>
    </div>
    
    <div id="stats" class="tab-content">
      <h3 class="tab-title">üìä Statistics</h3>
      <div class="minigame-container">
        <h4>Game Stats</h4>
        <div id="game-stats"></div>
        <h4>Offline Progress</h4>
        <div id="offline-stats"></div>
      </div>
    </div>
  </div>

  <!-- Golden Cookie -->
  <div id="golden-cookie-container"></div>

  <!-- Notifications -->
  <div id="notification-container"></div>
  
  <!-- Save Notification -->
  <div id="save-notification" class="save-notification">Game Saved!</div>
  
  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button id="close-settings" class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="setting-group">
          <h3>Save Management</h3>
          <button id="export-save" class="settings-btn">Export Save</button>
          <button id="import-save" class="settings-btn">Import Save</button>
          <button id="hard-reset" class="settings-btn danger">Hard Reset</button>
        </div>
        <div class="setting-group">
          <h3>Options</h3>
          <label class="switch">
            <input type="checkbox" id="notifications-toggle" checked>
            <span class="slider"></span>
            <span class="switch-label">Notifications</span>
          </label>
          <label class="switch">
            <input type="checkbox" id="animations-toggle" checked>
            <span class="slider"></span>
            <span class="switch-label">Animations</span>
          </label>
          <label class="switch">
            <input type="checkbox" id="offline-progress-toggle" checked>
            <span class="slider"></span>
            <span class="switch-label">Offline Progress</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Prestige Modal -->
  <div id="prestige-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Prestige</h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p>You will gain <span id="chips-gain" class="highlight">0</span> Heavenly Chips</p>
        <p>You will gain <span id="points-gain" class="highlight">0</span> Prestige Points</p>
        <p>Your CPS will increase by <span id="cps-boost" class="highlight">0%</span></p>
        <div class="prestige-rewards">
          <h3>Prestige Rewards</h3>
          <div id="prestige-rewards-list"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="confirm-prestige" class="modal-btn confirm">Ascend to Glory</button>
        <button class="modal-btn cancel">Not Yet</button>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // Game Data
    // =============================

    // Game Configuration
    const CONFIG = {
        VERSION: '2.0.0',
        SAVE_INTERVAL: 30000,
        GOLDEN_COOKIE_CHANCE: 0.005,
        GOLDEN_COOKIE_DURATION: 15,
        FRENZY_MULTIPLIER: 7,
        NOTIFICATION_DURATION: 3000,
        PRESTIGE_BASE: 1000000,
        PRESTIGE_POINTS_MULTIPLIER: 0.1,
        OFFLINE_MAX_TIME: 86400, // 24 hours in seconds
        PERFORMANCE_THRESHOLD: 1000
    };

    // =============================
    // Buildings (10 optimized buildings)
    // =============================
    const buildings = [
        { 
            id: "cursor",
            name: "Cursor", 
            emoji: "üëÜ", 
            baseCost: 15, 
            count: 0, 
            baseCps: 0.1, 
            unlocked: true,
            description: "Autoclicks once every 10 seconds"
        },
        { 
            id: "grandma",
            name: "Grandma", 
            emoji: "üëµ", 
            baseCost: 100, 
            count: 0, 
            baseCps: 1, 
            unlocked: true,
            description: "A nice grandma to bake cookies"
        },
        { 
            id: "farm",
            name: "Farm", 
            emoji: "üöú", 
            baseCost: 1100, 
            count: 0, 
            baseCps: 8, 
            unlocked: false,
            description: "Grows cookie plants in the field"
        },
        { 
            id: "mine",
            name: "Mine", 
            emoji: "‚õèÔ∏è", 
            baseCost: 12000, 
            count: 0, 
            baseCps: 47, 
            unlocked: false,
            description: "Mines cookie dough and chocolate chips"
        },
        { 
            id: "factory",
            name: "Factory", 
            emoji: "üè≠", 
            baseCost: 130000, 
            count: 0, 
            baseCps: 260, 
            unlocked: false,
            description: "Produces cookies at industrial rate"
        },
        { 
            id: "bank",
            name: "Bank", 
            emoji: "üè¶", 
            baseCost: 1400000, 
            count: 0, 
            baseCps: 1400, 
            unlocked: false,
            description: "Generates cookies from interest"
        },
        { 
            id: "temple",
            name: "Temple", 
            emoji: "üõï", 
            baseCost: 20000000, 
            count: 0, 
            baseCps: 7800, 
            unlocked: false,
            description: "Magically produces cookies from gods"
        },
        { 
            id: "wizard_tower",
            name: "Wizard Tower", 
            emoji: "üßô", 
            baseCost: 330000000, 
            count: 0, 
            baseCps: 44000, 
            unlocked: false,
            description: "Conjures cookies with magic spells"
        },
        { 
            id: "shipment",
            name: "Shipment", 
            emoji: "üöÄ", 
            baseCost: 5100000000, 
            count: 0, 
            baseCps: 260000, 
            unlocked: false,
            description: "Delivers cookies from space"
        },
        { 
            id: "alchemy_lab",
            name: "Alchemy Lab", 
            emoji: "‚öóÔ∏è", 
            baseCost: 75000000000, 
            count: 0, 
            baseCps: 1600000, 
            unlocked: false,
            description: "Turns lead into golden cookies"
        }
    ];

    // =============================
    // Upgrades (50 upgrades)
    // =============================
    const upgrades = [
        // Click upgrades (10)
        { id: "reinforced_finger", name: "Reinforced index finger", emoji: "üí™", cost: 100, bought: false, requirement: { type: "click", value: 1 }, effect: () => gameState.clickPower += 1, description: "+1 cookie per click", category: "click" },
        { id: "carpal_tunnel_cream", name: "Carpal tunnel prevention cream", emoji: "üíä", cost: 500, bought: false, requirement: { type: "click", value: 50 }, effect: () => gameState.clickPower += 2, description: "+2 cookies per click", category: "click" },
        { id: "ambidextrous", name: "Ambidextrous", emoji: "ü§≤", cost: 10000, bought: false, requirement: { type: "click", value: 200 }, effect: () => gameState.clickPower *= 2, description: "Double clicking power", category: "click" },
        { id: "thousand_fingers", name: "Thousand fingers", emoji: "üëê", cost: 100000, bought: false, requirement: { type: "click", value: 1000 }, effect: () => gameState.clickPower += 5, description: "+5 cookies per click", category: "click" },
        { id: "million_fingers", name: "Million fingers", emoji: "üëè", cost: 1000000, bought: false, requirement: { type: "click", value: 10000 }, effect: () => gameState.clickPower *= 1.5, description: "+50% clicking power", category: "click" },
        { id: "billion_fingers", name: "Billion fingers", emoji: "üôå", cost: 10000000, bought: false, requirement: { type: "click", value: 100000 }, effect: () => gameState.clickPower *= 2, description: "Double clicking power", category: "click" },
        { id: "trillion_fingers", name: "Trillion fingers", emoji: "üëç", cost: 100000000, bought: false, requirement: { type: "click", value: 1000000 }, effect: () => gameState.clickPower *= 3, description: "Triple clicking power", category: "click" },
        { id: "quadrillion_fingers", name: "Quadrillion fingers", emoji: "üëé", cost: 1000000000, bought: false, requirement: { type: "click", value: 10000000 }, effect: () => gameState.clickPower *= 5, description: "5x clicking power", category: "click" },
        { id: "quintillion_fingers", name: "Quintillion fingers", emoji: "‚úåÔ∏è", cost: 10000000000, bought: false, requirement: { type: "click", value: 100000000 }, effect: () => gameState.clickPower *= 10, description: "10x clicking power", category: "click" },
        { id: "sextillion_fingers", name: "Sextillion fingers", emoji: "ü§ü", cost: 100000000000, bought: false, requirement: { type: "click", value: 1000000000 }, effect: () => gameState.clickPower *= 20, description: "20x clicking power", category: "click" },

        // Grandma upgrades (5)
        { id: "forwards_from_grandma", name: "Forwards from grandma", emoji: "üìß", cost: 1000, bought: false, requirement: { type: "building", buildingId: "grandma", value: 1 }, effect: () => getBuildingById("grandma").cpsMultiplier = 2, description: "Double Grandma CPS", category: "grandma" },
        { id: "steel_plated_rolling_pins", name: "Steel-plated rolling pins", emoji: "ü•ñ", cost: 5000, bought: false, requirement: { type: "building", buildingId: "grandma", value: 5 }, effect: () => getBuildingById("grandma").cpsMultiplier = 1.5, description: "+50% Grandma CPS", category: "grandma" },
        { id: "elder_wrath", name: "Elder wrath", emoji: "üëπ", cost: 12000, bought: false, requirement: { type: "building", buildingId: "grandma", value: 10 }, effect: () => buildings.forEach(b => { if (b.id !== "grandma") b.cpsMultiplier = 1.1; }), description: "+10% CPS for other buildings", category: "grandma" },
        { id: "senile_elder_wrath", name: "Senile elder wrath", emoji: "üßì", cost: 50000, bought: false, requirement: { type: "building", buildingId: "grandma", value: 25 }, effect: () => buildings.forEach(b => { if (b.id !== "grandma") b.cpsMultiplier = 1.2; }), description: "+20% CPS for other buildings", category: "grandma" },
        { id: "ancient_elder_wrath", name: "Ancient elder wrath", emoji: "üßì", cost: 200000, bought: false, requirement: { type: "building", buildingId: "grandma", value: 50 }, effect: () => buildings.forEach(b => { if (b.id !== "grandma") b.cpsMultiplier = 1.5; }), description: "+50% CPS for other buildings", category: "grandma" },

        // Farm upgrades (5)
        { id: "fertilizer", name: "Fertilizer", emoji: "üí©", cost: 11000, bought: false, requirement: { type: "building", buildingId: "farm", value: 1 }, effect: () => getBuildingById("farm").cpsMultiplier = 2, description: "Double Farm CPS", category: "farm" },
        { id: "cookie_trees", name: "Cookie trees", emoji: "üå≥", cost: 55000, bought: false, requirement: { type: "building", buildingId: "farm", value: 5 }, effect: () => getBuildingById("farm").cpsMultiplier = 1.5, description: "+50% Farm CPS", category: "farm" },
        { id: "genetically_modified_cookies", name: "Genetically modified cookies", emoji: "üß¨", cost: 250000, bought: false, requirement: { type: "building", buildingId: "farm", value: 15 }, effect: () => getBuildingById("farm").cpsMultiplier = 2, description: "Double Farm CPS", category: "farm" },
        { id: "gmo_cookies_plus", name: "GMO cookies plus", emoji: "üß´", cost: 1000000, bought: false, requirement: { type: "building", buildingId: "farm", value: 30 }, effect: () => getBuildingById("farm").cpsMultiplier = 3, description: "Triple Farm CPS", category: "farm" },
        { id: "vertical_farming", name: "Vertical farming", emoji: "üè¢", cost: 5000000, bought: false, requirement: { type: "building", buildingId: "farm", value: 50 }, effect: () => getBuildingById("farm").cpsMultiplier = 5, description: "5x Farm CPS", category: "farm" },

        // Mine upgrades (5)
        { id: "sugar_gas", name: "Sugar gas", emoji: "‚õΩ", cost: 120000, bought: false, requirement: { type: "building", buildingId: "mine", value: 1 }, effect: () => getBuildingById("mine").cpsMultiplier = 2, description: "Double Mine CPS", category: "mine" },
        { id: "megadrill", name: "Megadrill", emoji: "üõ†Ô∏è", cost: 600000, bought: false, requirement: { type: "building", buildingId: "mine", value: 5 }, effect: () => getBuildingById("mine").cpsMultiplier = 1.5, description: "+50% Mine CPS", category: "mine" },
        { id: "ultradrill", name: "Ultradrill", emoji: "‚õèÔ∏è", cost: 2500000, bought: false, requirement: { type: "building", buildingId: "mine", value: 15 }, effect: () => getBuildingById("mine").cpsMultiplier = 2, description: "Double Mine CPS", category: "mine" },
        { id: "quantum_drill", name: "Quantum drill", emoji: "üî¨", cost: 10000000, bought: false, requirement: { type: "building", buildingId: "mine", value: 30 }, effect: () => getBuildingById("mine").cpsMultiplier = 3, description: "Triple Mine CPS", category: "mine" },
        { id: "singularity_drill", name: "Singularity drill", emoji: "‚ö´", cost: 50000000, bought: false, requirement: { type: "building", buildingId: "mine", value: 50 }, effect: () => getBuildingById("mine").cpsMultiplier = 5, description: "5x Mine CPS", category: "mine" },

        // Factory upgrades (5)
        { id: "sturdier_conveyor_belts", name: "Sturdier conveyor belts", emoji: "üì¶", cost: 1300000, bought: false, requirement: { type: "building", buildingId: "factory", value: 1 }, effect: () => getBuildingById("factory").cpsMultiplier = 2, description: "Double Factory CPS", category: "factory" },
        { id: "child_labor", name: "Child labor", emoji: "üë∂", cost: 6500000, bought: false, requirement: { type: "building", buildingId: "factory", value: 5 }, effect: () => getBuildingById("factory").cpsMultiplier = 1.5, description: "+50% Factory CPS", category: "factory" },
        { id: "sweatshop", name: "Sweatshop", emoji: "üè≠", cost: 30000000, bought: false, requirement: { type: "building", buildingId: "factory", value: 15 }, effect: () => getBuildingById("factory").cpsMultiplier = 2, description: "Double Factory CPS", category: "factory" },
        { id: "robotic_workers", name: "Robotic workers", emoji: "ü§ñ", cost: 150000000, bought: false, requirement: { type: "building", buildingId: "factory", value: 30 }, effect: () => getBuildingById("factory").cpsMultiplier = 3, description: "Triple Factory CPS", category: "factory" },
        { id: "ai_optimization", name: "AI optimization", emoji: "üß†", cost: 750000000, bought: false, requirement: { type: "building", buildingId: "factory", value: 50 }, effect: () => getBuildingById("factory").cpsMultiplier = 5, description: "5x Factory CPS", category: "factory" },

        // Bank upgrades (5)
        { id: "taller_tellers", name: "Taller tellers", emoji: "üè¶", cost: 14000000, bought: false, requirement: { type: "building", buildingId: "bank", value: 1 }, effect: () => getBuildingById("bank").cpsMultiplier = 2, description: "Double Bank CPS", category: "bank" },
        { id: "scissor-resistant_credit_cards", name: "Scissor-resistant credit cards", emoji: "üí≥", cost: 70000000, bought: false, requirement: { type: "building", buildingId: "bank", value: 5 }, effect: () => getBuildingById("bank").cpsMultiplier = 1.5, description: "+50% Bank CPS", category: "bank" },
        { id: "acid-resistant_credit_cards", name: "Acid-resistant credit cards", emoji: "üí≥", cost: 350000000, bought: false, requirement: { type: "building", buildingId: "bank", value: 15 }, effect: () => getBuildingById("bank").cpsMultiplier = 2, description: "Double Bank CPS", category: "bank" },
        { id: "quantum_credit_cards", name: "Quantum credit cards", emoji: "üí≥", cost: 1750000000, bought: false, requirement: { type: "building", buildingId: "bank", value: 30 }, effect: () => getBuildingById("bank").cpsMultiplier = 3, description: "Triple Bank CPS", category: "bank" },
        { id: "singularity_credit_cards", name: "Singularity credit cards", emoji: "üí≥", cost: 8750000000, bought: false, requirement: { type: "building", buildingId: "bank", value: 50 }, effect: () => getBuildingById("bank").cpsMultiplier = 5, description: "5x Bank CPS", category: "bank" },

        // Temple upgrades (5)
        { id: "golden_idols", name: "Golden idols", emoji: "üóø", cost: 200000000, bought: false, requirement: { type: "building", buildingId: "temple", value: 1 }, effect: () => getBuildingById("temple").cpsMultiplier = 2, description: "Double Temple CPS", category: "temple" },
        { id: "sacrifices", name: "Sacrifices", emoji: "‚öîÔ∏è", cost: 1000000000, bought: false, requirement: { type: "building", buildingId: "temple", value: 5 }, effect: () => getBuildingById("temple").cpsMultiplier = 1.5, description: "+50% Temple CPS", category: "temple" },
        { id: "enlarged_sacrifice_altar", name: "Enlarged sacrifice altar", emoji: "‚öîÔ∏è", cost: 5000000000, bought: false, requirement: { type: "building", buildingId: "temple", value: 15 }, effect: () => getBuildingById("temple").cpsMultiplier = 2, description: "Double Temple CPS", category: "temple" },
        { id: "great_bacon_sacrifice", name: "Great bacon sacrifice", emoji: "ü•ì", cost: 25000000000, bought: false, requirement: { type: "building", buildingId: "temple", value: 30 }, effect: () => getBuildingById("temple").cpsMultiplier = 3, description: "Triple Temple CPS", category: "temple" },
        { id: "ultimate_sacrifice", name: "Ultimate sacrifice", emoji: "‚ö∞Ô∏è", cost: 125000000000, bought: false, requirement: { type: "building", buildingId: "temple", value: 50 }, effect: () => getBuildingById("temple").cpsMultiplier = 5, description: "5x Temple CPS", category: "temple" },

        // Global upgrades (10)
        { id: "vanilla_nerve", name: "Vanilla nerve", emoji: "üç¶", cost: 1000000000, bought: false, requirement: { type: "cookies", value: 1000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.01), description: "+1% CPS for all buildings", category: "global" },
        { id: "eternal_loop", name: "Eternal loop", emoji: "‚àû", cost: 1000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.02), description: "+2% CPS for all buildings", category: "global" },
        { id: "time_warp", name: "Time warp", emoji: "‚è∞", cost: 1000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.03), description: "+3% CPS for all buildings", category: "global" },
        { id: "dimensional_warp", name: "Dimensional warp", emoji: "üåÄ", cost: 1000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.05), description: "+5% CPS for all buildings", category: "global" },
        { id: "reality_warp", name: "Reality warp", emoji: "üåå", cost: 1000000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.1), description: "+10% CPS for all buildings", category: "global" },
        { id: "omnipotence", name: "Omnipotence", emoji: "üëÅÔ∏è", cost: 1000000000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.2), description: "+20% CPS for all buildings", category: "global" },
        { id: "transcendence", name: "Transcendence", emoji: "‚ú®", cost: 1000000000000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 1.5), description: "+50% CPS for all buildings", category: "global" },
        { id: "divinity", name: "Divinity", emoji: "üëº", cost: 1000000000000000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 2), description: "Double CPS for all buildings", category: "global" },
        { id: "infinity", name: "Infinity", emoji: "‚ôæÔ∏è", cost: 1000000000000000000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 3), description: "Triple CPS for all buildings", category: "global" },
        { id: "absolute_infinity", name: "Absolute infinity", emoji: "üîÆ", cost: 1000000000000000000000000000000000000, bought: false, requirement: { type: "cookies", value: 1000000000000000000000000000000000000 }, effect: () => buildings.forEach(b => b.cpsMultiplier *= 5), description: "5x CPS for all buildings", category: "global" }
    ];

    // =============================
    // Prestige Upgrades (20 upgrades)
    // =============================
    const prestigeUpgrades = [
        { id: "heavenly_cookies", name: "Heavenly Cookies", emoji: "üç™", cost: 1, bought: false, effect: (chips) => 1 + (chips * 0.01), description: "+1% CPS per Heavenly Chip", category: "cps" },
        { id: "persistent_memory", name: "Persistent Memory", emoji: "üß†", cost: 5, bought: false, effect: (chips) => Math.min(1, Math.floor(chips / 5)), description: "Keep 1 building after prestige", category: "building" },
        { id: "double_cookies", name: "Double Cookies", emoji: "2Ô∏è‚É£", cost: 25, bought: false, effect: (chips) => chips >= 25 ? 2 : 1, description: "Double cookie production from clicks", category: "click" },
        { id: "lucky_number", name: "Lucky Number", emoji: "üçÄ", cost: 50, bought: false, effect: (chips) => chips >= 50 ? 1.1 : 1, description: "+10% chance for golden cookies", category: "golden" },
        { id: "serendipity", name: "Serendipity", emoji: "üéØ", cost: 100, bought: false, effect: (chips) => chips >= 100 ? 1.5 : 1, description: "Golden cookies last 50% longer", category: "golden" },
        { id: "divine_intervention", name: "Divine Intervention", emoji: "üëº", cost: 200, bought: false, effect: (chips) => chips >= 200 ? 1.2 : 1, description: "+20% CPS from all sources", category: "cps" },
        { id: "chronomancy", name: "Chronomancy", emoji: "‚è≥", cost: 500, bought: false, effect: (chips) => chips >= 500 ? 2 : 1, description: "Double offline production time", category: "offline" },
        { id: "quantum_entanglement", name: "Quantum Entanglement", emoji: "‚öõÔ∏è", cost: 1000, bought: false, effect: (chips) => chips >= 1000 ? 1.5 : 1, description: "+50% building production", category: "building" },
        { id: "reality_bending", name: "Reality Bending", emoji: "üåÄ", cost: 2000, bought: false, effect: (chips) => chips >= 2000 ? 0.9 : 1, description: "-10% building costs", category: "cost" },
        { id: "multiversal_echo", name: "Multiversal Echo", emoji: "üåå", cost: 5000, bought: false, effect: (chips) => chips >= 5000 ? 1.1 : 1, description: "+10% CPS per building owned", category: "cps" },
        { id: "temporal_flux", name: "Temporal Flux", emoji: "‚è∞", cost: 10000, bought: false, effect: (chips) => chips >= 10000 ? 1.25 : 1, description: "+25% golden cookie effect duration", category: "golden" },
        { id: "cosmic_awareness", name: "Cosmic Awareness", emoji: "üëÅÔ∏è", cost: 20000, bought: false, effect: (chips) => chips >= 20000 ? 1.3 : 1, description: "+30% CPS during frenzy", category: "cps" },
        { id: "dimensional_folding", name: "Dimensional Folding", emoji: "üì¶", cost: 50000, bought: false, effect: (chips) => chips >= 50000 ? 0.85 : 1, description: "-15% building costs", category: "cost" },
        { id: "quantum_superposition", name: "Quantum Superposition", emoji: "üî¨", cost: 100000, bought: false, effect: (chips) => chips >= 100000 ? 1.4 : 1, description: "+40% building production", category: "building" },
        { id: "reality_anchor", name: "Reality Anchor", emoji: "‚öì", cost: 200000, bought: false, effect: (chips) => chips >= 200000 ? 3 : 1, description: "Triple offline production", category: "offline" },
        { id: "chronal_acceleration", name: "Chronal Acceleration", emoji: "‚ö°", cost: 500000, bought: false, effect: (chips) => chips >= 500000 ? 1.5 : 1, description: "+50% CPS from all sources", category: "cps" },
        { id: "omnidimensional_sight", name: "Omnidimensional Sight", emoji: "üëÄ", cost: 1000000, bought: false, effect: (chips) => chips >= 1000000 ? 0.8 : 1, description: "-20% building costs", category: "cost" },
        { id: "quantum_causality", name: "Quantum Causality", emoji: "üîó", cost: 2000000, bought: false, effect: (chips) => chips >= 2000000 ? 2 : 1, description: "Double golden cookie spawn rate", category: "golden" },
        { id: "reality_forging", name: "Reality Forging", emoji: "‚öíÔ∏è", cost: 5000000, bought: false, effect: (chips) => chips >= 5000000 ? 1.75 : 1, description: "+75% building production", category: "building" },
        { id: "absolute_power", name: "Absolute Power", emoji: "‚ôæÔ∏è", cost: 10000000, bought: false, effect: (chips) => chips >= 10000000 ? 0.5 : 1, description: "-50% building costs", category: "cost" }
    ];

    // =============================
    // Achievements (15 achievements)
    // =============================
    const achievements = [
        { id: "first_click", name: "First Click!", description: "Click the cookie for the first time", unlocked: false, check: () => gameState.totalClicks >= 1, reward: { type: "cps", value: 0.1 } },
        { id: "hundred_clicks", name: "Cookie Monster", description: "Reach 100 clicks", unlocked: false, check: () => gameState.totalClicks >= 100, reward: { type: "click", value: 1 } },
        { id: "thousand_clicks", name: "Clicking Champion", description: "Reach 1,000 clicks", unlocked: false, check: () => gameState.totalClicks >= 1000, reward: { type: "click", value: 2 } },
        { id: "million_clicks", name: "Clicking Legend", description: "Reach 1,000,000 clicks", unlocked: false, check: () => gameState.totalClicks >= 1000000, reward: { type: "click", value: 5 } },
        { id: "thousand_cookies", name: "Cookie Collector", description: "Earn 1,000 cookies total", unlocked: false, check: () => gameState.totalCookiesEarned >= 1000, reward: { type: "cps", value: 1 } },
        { id: "million_cookies", name: "Cookie Millionaire", description: "Earn 1,000,000 cookies total", unlocked: false, check: () => gameState.totalCookiesEarned >= 1000000, reward: { type: "cps", value: 5 } },
        { id: "billion_cookies", name: "Cookie Billionaire", description: "Earn 1,000,000,000 cookies total", unlocked: false, check: () => gameState.totalCookiesEarned >= 1000000000, reward: { type: "cps", value: 10 } },
        { id: "first_golden", name: "Golden Touch", description: "Click your first golden cookie", unlocked: false, check: () => gameState.goldenCookiesClicked >= 1, reward: { type: "golden", value: 0.1 } },
        { id: "golden_expert", name: "Golden Expert", description: "Click 10 golden cookies", unlocked: false, check: () => gameState.goldenCookiesClicked >= 10, reward: { type: "golden", value: 0.2 } },
        { id: "first_building", name: "Real Estate", description: "Buy your first building", unlocked: false, check: () => buildings.some(b => b.count > 0), reward: { type: "discount", value: 0.05 } },
        { id: "building_collector", name: "Building Collector", description: "Own 10 of each building", unlocked: false, check: () => buildings.every(b => b.count >= 10), reward: { type: "cps", value: 15 } },
        { id: "first_prestige", name: "Rebirth", description: "Prestige for the first time", unlocked: false, check: () => gameState.prestigeCount >= 1, reward: { type: "prestige", value: 0.1 } },
        { id: "prestige_master", name: "Prestige Master", description: "Prestige 10 times", unlocked: false, check: () => gameState.prestigeCount >= 10, reward: { type: "prestige", value: 0.5 } },
        { id: "upgrade_hunter", name: "Upgrade Hunter", description: "Buy 25 upgrades", unlocked: false, check: () => upgrades.filter(u => u.bought).length >= 25, reward: { type: "cps", value: 20 } },
        { id: "completionist", name: "Completionist", description: "Unlock all achievements", unlocked: false, check: () => achievements.filter(a => a.unlocked).length >= achievements.length - 1, reward: { type: "global", value: 2 } }
    ];

    // =============================
    // Golden Cookie Effects
    // =============================
    const goldenCookieEffects = [
        {
            name: "Frenzy",
            duration: 13,
            effect: () => {
                gameState.isFrenzyActive = true;
                gameState.frenzyTimeLeft = 13 * (gameState.heavenlyChips >= 100 ? 1.5 : 1);
                document.getElementById('cookie').classList.add('frenzy-active');
            },
            expire: () => {
                gameState.isFrenzyActive = false;
                document.getElementById('cookie').classList.remove('frenzy-active');
            },
            chance: 0.7
        },
        {
            name: "Lucky",
            duration: 0,
            effect: () => {
                const bonusMultiplier = gameState.heavenlyChips >= 50 ? 1.1 : 1;
                const bonus = Math.floor(gameState.cps * 60 * 0.1 * bonusMultiplier);
                gameState.cookies += bonus;
                showFloatingText(window.innerWidth / 2, 100, `+${formatNumber(bonus)}!`, '#FFD700');
                showNotification(`Lucky! +${formatNumber(bonus)} cookies!`);
            },
            expire: () => {},
            chance: 0.3
        }
    ];

    // =============================
    // Utility Functions
    // =============================
    function getBuildingById(id) {
        return buildings.find(b => b.id === id);
    }

    function getUpgradeById(id) {
        return upgrades.find(u => u.id === id);
    }

    function getPrestigeUpgradeById(id) {
        return prestigeUpgrades.find(pu => pu.id === id);
    }

    function formatNumber(num) {
        if (num >= 1e15) return (num / 1e15).toFixed(2) + 'Qa';
        if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
        if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
        if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
        if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
        return Math.floor(num).toString();
    }

    function formatTime(seconds) {
        if (seconds < 60) return `${Math.floor(seconds)}s`;
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
        return `${minutes}m ${secs}s`;
    }

    // Initialize building multipliers
    buildings.forEach(building => {
        building.cpsMultiplier = 1;
    });

    // =============================
    // Game State
    // =============================
    const gameState = {
        cookies: 0,
        totalCookiesEarned: 0,
        cps: 0,
        clickPower: 1,
        totalClicks: 0,
        goldenCookiesClicked: 0,
        playTime: 0,
        heavenlyChips: 0,
        prestigePoints: 0,
        prestigeCount: 0,
        isFrenzyActive: false,
        frenzyTimeLeft: 0,
        lastSave: Date.now(),
        lastUpdate: Date.now(),
        lastOfflineTime: Date.now(),
        notificationsEnabled: true,
        animationsEnabled: true,
        offlineProgressEnabled: true,
        version: CONFIG.VERSION
    };

    // =============================
    // DOM Elements
    // =============================
    const cookieEl = document.getElementById('cookie');
    const cookiesEl = document.getElementById('cookies');
    const cpsEl = document.getElementById('cps');
    const heavenlyChipsEl = document.getElementById('heavenly-chips');
    const prestigePointsEl = document.getElementById('prestige-points');
    const buildingsEl = document.getElementById('buildings');
    const upgradesEl = document.getElementById('upgrades');
    const prestigeUpgradesEl = document.getElementById('prestige-upgrades-list');
    const achievementsEl = document.getElementById('achievements-list');
    const gameStatsEl = document.getElementById('game-stats');
    const offlineStatsEl = document.getElementById('offline-stats');
    const prestigeBtn = document.getElementById('prestige-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const saveBtn = document.getElementById('save-btn');
    const loadBtn = document.getElementById('load-btn');
    const settingsModal = document.getElementById('settings-modal');
    const prestigeModal = document.getElementById('prestige-modal');

    // =============================
    // Initialization
    // =============================
    function initGame() {
        loadGame();
        setupEventListeners();
        createMilkBubbles();
        calculateOfflineProgress();
        updateUI();
        startGameLoop();
        
        // Show welcome message
        setTimeout(() => {
            showNotification('Welcome to Cookie Clicker Deluxe!');
        }, 1000);
    }

    function setupEventListeners() {
        // Cookie click events
        cookieEl.addEventListener('click', handleCookieClick);
        cookieEl.addEventListener('touchstart', handleCookieClick, { passive: false });
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                switchTab(e.currentTarget.dataset.tab);
            });
        });
        
        // Prestige button
        prestigeBtn.addEventListener('click', showPrestigeModal);
        
        // Settings buttons
        settingsBtn.addEventListener('click', () => toggleModal(settingsModal));
        saveBtn.addEventListener('click', manualSave);
        loadBtn.addEventListener('click', manualLoad);
        
        // Modal close buttons
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                toggleModal(e.target.closest('.modal'));
            });
        });
        
        // Settings modal buttons
        document.getElementById('export-save').addEventListener('click', exportSave);
        document.getElementById('import-save').addEventListener('click', importSave);
        document.getElementById('hard-reset').addEventListener('click', hardReset);
        document.getElementById('confirm-prestige').addEventListener('click', doPrestige);
        
        // Settings toggles
        document.getElementById('notifications-toggle').addEventListener('change', toggleNotifications);
        document.getElementById('animations-toggle').addEventListener('change', toggleAnimations);
        document.getElementById('offline-progress-toggle').addEventListener('change', toggleOfflineProgress);
        
        // Cancel buttons
        document.querySelectorAll('.modal-btn.cancel').forEach(btn => {
            btn.addEventListener('click', (e) => {
                toggleModal(e.target.closest('.modal'));
            });
        });
        
        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) toggleModal(modal);
            });
        });
    }

    // =============================
    // UI Functions
    // =============================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
        
        if (tabName === 'stats') {
            updateStatsTab();
        }
    }

    function updateUI() {
        updateStats();
        updateBuildings();
        updateUpgrades();
        updatePrestigeUpgrades();
        updateAchievements();
        updatePrestigeButton();
    }

    function updateStats() {
        cookiesEl.textContent = formatNumber(gameState.cookies);
        cpsEl.textContent = formatNumber(gameState.cps);
        heavenlyChipsEl.textContent = formatNumber(gameState.heavenlyChips);
        prestigePointsEl.textContent = formatNumber(gameState.prestigePoints);
        
        // Update multiplier display
        const multiplierDisplay = document.getElementById('cookie-multiplier');
        let multiplier = 1;
        if (gameState.isFrenzyActive) multiplier *= CONFIG.FRENZY_MULTIPLIER;
        multiplierDisplay.textContent = `x${multiplier}`;
    }

    function updateBuildings() {
        buildingsEl.innerHTML = '<h3 class="tab-title">üèóÔ∏è Buildings</h3>';
        buildings.forEach((b, i) => {
            if (!b.unlocked && gameState.cookies >= b.baseCost * 0.5) {
                b.unlocked = true;
                if (gameState.notificationsEnabled) {
                    showNotification(`Unlocked: ${b.name}!`);
                }
            }
            
            if (b.unlocked) {
                const cost = calculateBuildingCost(b);
                const buildingDiv = document.createElement('div');
                buildingDiv.className = 'building-item';
                buildingDiv.innerHTML = `
                    <div class="building-header">
                        <span class="building-emoji">${b.emoji}</span>
                        <div class="building-info">
                            <div class="building-name">${b.name} (${b.count})</div>
                            <div class="building-desc">${b.description}</div>
                        </div>
                    </div>
                    <div class="building-stats">
                        <span>${formatNumber(getBuildingCPS(b))} CPS</span>
                        <span>Cost: ${formatNumber(cost)}</span>
                    </div>
                `;
                
                const btn = document.createElement('button');
                btn.textContent = `Buy ${b.name}`;
                btn.disabled = gameState.cookies < cost;
                btn.addEventListener('click', () => buyBuilding(i));
                buildingDiv.appendChild(btn);
                
                buildingsEl.appendChild(buildingDiv);
            }
        });
    }

    function updateUpgrades() {
        upgradesEl.innerHTML = '<h3 class="tab-title">‚ö° Upgrades</h3>';
        let availableUpgrades = 0;
        
        upgrades.forEach((u, i) => {
            if (!u.bought && isUpgradeAvailable(u)) {
                availableUpgrades++;
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'upgrade-item';
                upgradeDiv.innerHTML = `
                    <div class="upgrade-header">
                        <span class="upgrade-emoji">${u.emoji}</span>
                        <div class="upgrade-info">
                            <div class="upgrade-name">${u.name}</div>
                            <div class="upgrade-desc">${u.description}</div>
                        </div>
                    </div>
                    <div class="upgrade-stats">
                        <span>Cost: ${formatNumber(u.cost)}</span>
                    </div>
                `;
                
                const btn = document.createElement('button');
                btn.textContent = 'Buy Upgrade';
                btn.disabled = gameState.cookies < u.cost;
                btn.addEventListener('click', () => buyUpgrade(i));
                upgradeDiv.appendChild(btn);
                
                upgradesEl.appendChild(upgradeDiv);
            }
        });
        
        if (availableUpgrades === 0) {
            upgradesEl.innerHTML += '<p>No upgrades available. Keep playing to unlock more!</p>';
        }
    }

    function updatePrestigeUpgrades() {
        prestigeUpgradesEl.innerHTML = '';
        let availableUpgrades = 0;
        
        prestigeUpgrades.forEach((pu, i) => {
            if (!pu.bought && gameState.prestigePoints >= pu.cost) {
                availableUpgrades++;
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'prestige-upgrade-item';
                upgradeDiv.innerHTML = `
                    <div class="prestige-upgrade-header">
                        <span class="prestige-upgrade-emoji">${pu.emoji}</span>
                        <div class="prestige-upgrade-info">
                            <div class="prestige-upgrade-name">${pu.name}</div>
                            <div class="prestige-upgrade-desc">${pu.description}</div>
                        </div>
                    </div>
                    <div class="prestige-upgrade-stats">
                        <span>Cost: ${formatNumber(pu.cost)} prestige points</span>
                    </div>
                `;
                
                const btn = document.createElement('button');
                btn.className = 'prestige-upgrade-btn';
                btn.textContent = 'Buy Upgrade';
                btn.disabled = gameState.prestigePoints < pu.cost;
                btn.addEventListener('click', () => buyPrestigeUpgrade(i));
                upgradeDiv.appendChild(btn);
                
                prestigeUpgradesEl.appendChild(upgradeDiv);
            }
        });
        
        if (availableUpgrades === 0) {
            prestigeUpgradesEl.innerHTML = '<p>No prestige upgrades available. Prestige to earn more points!</p>';
        }
    }

    function updateAchievements() {
        achievementsEl.innerHTML = '';
        achievements.forEach(achievement => {
            const achieved = achievement.check();
            if (achieved && !achievement.unlocked) {
                achievement.unlocked = true;
                applyAchievementReward(achievement);
                if (gameState.notificationsEnabled) {
                    showNotification(`Achievement unlocked: ${achievement.name}!`);
                }
            }
            
            const achievementDiv = document.createElement('div');
            achievementDiv.className = `achievement ${achievement.unlocked ? '' : 'locked'}`;
            achievementDiv.innerHTML = `
                <span class="achievement-icon">${achievement.unlocked ? 'üèÜ' : 'üîí'}</span>
                <div class="achievement-info">
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                    <div class="achievement-status">${achievement.unlocked ? '‚úÖ Unlocked' : 'üîí Locked'}</div>
                </div>
            `;
            achievementsEl.appendChild(achievementDiv);
        });
    }

    function updateStatsTab() {
        // Game statistics
        gameStatsEl.innerHTML = `
            <p>Total Clicks: ${formatNumber(gameState.totalClicks)}</p>
            <p>Total Play Time: ${formatTime(gameState.playTime)}</p>
            <p>Golden Cookies Clicked: ${formatNumber(gameState.goldenCookiesClicked)}</p>
            <p>Prestige Count: ${formatNumber(gameState.prestigeCount)}</p>
            <p>Total Cookies Earned: ${formatNumber(gameState.totalCookiesEarned)}</p>
        `;
        
        // Offline statistics
        offlineStatsEl.innerHTML = `
            <p>Offline Progress: ${gameState.offlineProgressEnabled ? 'Enabled' : 'Disabled'}</p>
            <p>Last Offline Calculation: ${new Date(gameState.lastOfflineTime).toLocaleTimeString()}</p>
        `;
    }

    function updatePrestigeButton() {
        const chipsGained = calculateHeavenlyChips();
        const pointsGained = calculatePrestigePoints();
        prestigeBtn.textContent = `Prestige (${formatNumber(chipsGained)} chips + ${formatNumber(pointsGained)} points)`;
        prestigeBtn.disabled = chipsGained <= 0 && pointsGained <= 0;
    }

    // =============================
    // Game Mechanics
    // =============================
    function calculateCPS() {
        let totalCPS = 0;
        buildings.forEach(b => {
            totalCPS += b.count * b.baseCps * b.cpsMultiplier;
        });
        
        // Apply prestige bonuses
        const heavenlyBonus = 1 + (gameState.heavenlyChips * 0.01);
        totalCPS *= heavenlyBonus;
        
        // Apply prestige upgrades
        prestigeUpgrades.forEach(pu => {
            if (pu.bought) {
                switch (pu.category) {
                    case "cps":
                        totalCPS *= pu.effect(gameState.heavenlyChips);
                        break;
                    case "building":
                        // Building bonuses are applied in getBuildingCPS
                        break;
                }
            }
        });
        
        // Apply frenzy multiplier
        if (gameState.isFrenzyActive) {
            const frenzyMultiplier = prestigeUpgrades.find(pu => pu.id === "cosmic_awareness" && pu.bought) 
                ? CONFIG.FRENZY_MULTIPLIER * 1.3 
                : CONFIG.FRENZY_MULTIPLIER;
            totalCPS *= frenzyMultiplier;
        }
        
        gameState.cps = totalCPS;
    }

    function calculateBuildingCost(building) {
        let cost = building.baseCost * Math.pow(1.15, building.count);
        
        // Apply cost reduction from prestige upgrades
        prestigeUpgrades.forEach(pu => {
            if (pu.bought && pu.category === "cost") {
                cost *= pu.effect(gameState.heavenlyChips);
            }
        });
        
        // Apply achievement discounts
        achievements.forEach(a => {
            if (a.unlocked && a.reward.type === "discount") {
                cost *= (1 - a.reward.value);
            }
        });
        
        return Math.floor(cost);
    }

    function getBuildingCPS(building) {
        let cps = building.count * building.baseCps * building.cpsMultiplier;
        
        // Apply building-specific prestige bonuses
        prestigeUpgrades.forEach(pu => {
            if (pu.bought && pu.category === "building") {
                cps *= pu.effect(gameState.heavenlyChips);
            }
        });
        
        const heavenlyBonus = 1 + (gameState.heavenlyChips * 0.01);
        return cps * heavenlyBonus;
    }

    function isUpgradeAvailable(upgrade) {
        switch (upgrade.requirement.type) {
            case "click":
                return gameState.totalClicks >= upgrade.requirement.value;
            case "building":
                const building = getBuildingById(upgrade.requirement.buildingId);
                return building && building.count >= upgrade.requirement.value;
            case "cookies":
                return gameState.totalCookiesEarned >= upgrade.requirement.value;
            default:
                return true;
        }
    }

    function buyBuilding(index) {
        const b = buildings[index];
        const cost = calculateBuildingCost(b);
        if (gameState.cookies >= cost) {
            gameState.cookies -= cost;
            b.count++;
            calculateCPS();
            updateUI();
        }
    }

    function buyUpgrade(index) {
        const u = upgrades[index];
        if (gameState.cookies >= u.cost && !u.bought) {
            gameState.cookies -= u.cost;
            u.bought = true;
            u.effect();
            calculateCPS();
            updateUI();
            
            if (gameState.notificationsEnabled) {
                showNotification(`Upgrade purchased: ${u.name}!`);
            }
        }
    }

    function buyPrestigeUpgrade(index) {
        const pu = prestigeUpgrades[index];
        if (gameState.prestigePoints >= pu.cost && !pu.bought) {
            gameState.prestigePoints -= pu.cost;
            pu.bought = true;
            calculateCPS(); // Recalculate CPS as some upgrades affect it
            updatePrestigeUpgrades();
            updateUI();
            
            if (gameState.notificationsEnabled) {
                showNotification(`Prestige upgrade purchased: ${pu.name}!`);
            }
        }
    }

    function applyAchievementReward(achievement) {
        switch (achievement.reward.type) {
            case "cps":
                gameState.cps += achievement.reward.value;
                break;
            case "click":
                gameState.clickPower += achievement.reward.value;
                break;
            case "discount":
                // Discount is applied in calculateBuildingCost
                break;
            case "golden":
                CONFIG.GOLDEN_COOKIE_CHANCE += achievement.reward.value;
                break;
            case "prestige":
                gameState.heavenlyChips += achievement.reward.value;
                calculateCPS();
                break;
            case "global":
                buildings.forEach(b => {
                    b.cpsMultiplier *= achievement.reward.value;
                });
                calculateCPS();
                break;
        }
    }

    // =============================
    // Click Handling
    // =============================
    function handleCookieClick(e) {
        const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        let clickValue = gameState.clickPower;
        
        // Apply click bonuses from prestige upgrades
        const clickMultiplier = prestigeUpgrades.find(pu => pu.id === "double_cookies" && pu.bought) 
            ? getPrestigeUpgradeById("double_cookies").effect(gameState.heavenlyChips) 
            : 1;
        clickValue *= clickMultiplier;
        
        if (gameState.isFrenzyActive) {
            clickValue *= CONFIG.FRENZY_MULTIPLIER;
        }
        
        gameState.cookies += clickValue;
        gameState.totalCookiesEarned += clickValue;
        gameState.totalClicks++;
        
        // Add click animation
        if (gameState.animationsEnabled) {
            cookieEl.classList.add('shake');
            setTimeout(() => cookieEl.classList.remove('shake'), 500);
            spawnFloatingText(x, y, `+${formatNumber(clickValue)}`);
        }
        
        updateUI();
        
        if (e.type.includes('touch')) e.preventDefault();
    }

    // =============================
    // Golden Cookies
    // =============================
    function spawnGoldenCookie() {
        if (!gameState.animationsEnabled) return;
        
        const goldenCookie = document.createElement('div');
        goldenCookie.className = 'golden-cookie';
        goldenCookie.textContent = 'üç™';
        goldenCookie.style.left = `${Math.random() * 80 + 10}%`;
        goldenCookie.style.top = `${Math.random() * 60 + 20}%`;
        
        goldenCookie.addEventListener('click', () => {
            gameState.goldenCookiesClicked++;
            const effect = getRandomGoldenCookieEffect();
            effect.effect();
            
            if (gameState.notificationsEnabled) {
                showNotification(`Golden Cookie: ${effect.name}!`);
            }
            
            goldenCookie.remove();
        });
        
        document.getElementById('golden-cookie-container').appendChild(goldenCookie);
        
        // Remove after duration
        setTimeout(() => {
            if (goldenCookie.parentNode) {
                goldenCookie.remove();
            }
        }, 15000);
    }

    function getRandomGoldenCookieEffect() {
        const rand = Math.random();
        let cumulativeChance = 0;
        
        for (const effect of goldenCookieEffects) {
            cumulativeChance += effect.chance;
            if (rand <= cumulativeChance) {
                return effect;
            }
        }
        
        return goldenCookieEffects[0];
    }

    // =============================
    // Prestige System
    // =============================
    function calculateHeavenlyChips() {
        return Math.max(0, Math.floor(Math.sqrt(gameState.totalCookiesEarned / CONFIG.PRESTIGE_BASE) * 10) - gameState.heavenlyChips);
    }

    function calculatePrestigePoints() {
        return Math.max(0, Math.floor(Math.pow(gameState.totalCookiesEarned / CONFIG.PRESTIGE_BASE, 0.25) * CONFIG.PRESTIGE_POINTS_MULTIPLIER) - gameState.prestigePoints);
    }

    function showPrestigeModal() {
        const chipsGained = calculateHeavenlyChips();
        const pointsGained = calculatePrestigePoints();
        
        if (chipsGained <= 0 && pointsGained <= 0) return;
        
        document.getElementById('chips-gain').textContent = formatNumber(chipsGained);
        document.getElementById('points-gain').textContent = formatNumber(pointsGained);
        document.getElementById('cps-boost').textContent = `${chipsGained}%`;
        
        toggleModal(prestigeModal);
    }

    function doPrestige() {
        const chipsGained = calculateHeavenlyChips();
        const pointsGained = calculatePrestigePoints();
        
        gameState.heavenlyChips += chipsGained;
        gameState.prestigePoints += pointsGained;
        gameState.prestigeCount++;
        
        if (gameState.notificationsEnabled) {
            showNotification(`Ascended! Gained ${formatNumber(chipsGained)} Heavenly Chips and ${formatNumber(pointsGained)} Prestige Points!`);
        }
        
        resetGameState();
        toggleModal(prestigeModal);
    }

    function resetGameState() {
        gameState.cookies = 0;
        gameState.totalClicks = 0;
        gameState.goldenCookiesClicked = 0;
        gameState.isFrenzyActive = false;
        gameState.frenzyTimeLeft = 0;
        
        // Reset buildings (keep some based on prestige)
        const keepBuildings = Math.min(1, Math.floor(gameState.heavenlyChips / 5));
        
        buildings.forEach(b => {
            if (keepBuildings > 0 && b.count > 0) {
                // Keep 1 building of the highest type
                b.count = Math.min(1, b.count);
            } else {
                b.count = 0;
            }
            b.unlocked = b.id === "cursor" || b.id === "grandma";
            b.cpsMultiplier = 1;
        });
        
        // Reset upgrades (keep prestige upgrades)
        upgrades.forEach(u => u.bought = false);
        
        calculateCPS();
        saveGame();
        updateUI();
    }

    // =============================
    // Offline Progress
    // =============================
    function calculateOfflineProgress() {
        if (!gameState.offlineProgressEnabled) return;
        
        const now = Date.now();
        const offlineTime = Math.min((now - gameState.lastOfflineTime) / 1000, CONFIG.OFFLINE_MAX_TIME);
        
        if (offlineTime > 60) { // Only show if offline for more than 1 minute
            const offlineEarnings = Math.floor(gameState.cps * offlineTime * 0.5); // 50% of online production
            
            // Apply offline bonuses from prestige upgrades
            const offlineMultiplier = prestigeUpgrades.find(pu => pu.id === "chronomancy" && pu.bought) 
                ? getPrestigeUpgradeById("chronomancy").effect(gameState.heavenlyChips) 
                : 1;
            const finalEarnings = Math.floor(offlineEarnings * offlineMultiplier);
            
            gameState.cookies += finalEarnings;
            gameState.totalCookiesEarned += finalEarnings;
            
            if (gameState.notificationsEnabled && finalEarnings > 0) {
                showNotification(`Offline earnings: +${formatNumber(finalEarnings)} cookies!`, 'offline-notification');
            }
        }
        
        gameState.lastOfflineTime = now;
    }

    // =============================
    // Animation Functions
    // =============================
    function createMilkBubbles() {
        const milkEffect = document.querySelector('.milk-effect');
        if (!milkEffect || !gameState.animationsEnabled) return;
        
        for (let i = 0; i < 10; i++) {
            const bubble = document.createElement('div');
            bubble.className = 'milk-bubble';
            
            const size = Math.random() * 15 + 5;
            const left = Math.random() * 100;
            const top = Math.random() * 100;
            const delay = Math.random() * 5;
            
            bubble.style.width = size + 'px';
            bubble.style.height = size + 'px';
            bubble.style.left = left + '%';
            bubble.style.top = top + '%';
            bubble.style.animationDelay = delay + 's';
            
            milkEffect.appendChild(bubble);
        }
    }

    function spawnFloatingText(x, y, text, color = '#ffcc66') {
        if (!gameState.animationsEnabled) return;
        
        const floatingText = document.createElement('div');
        floatingText.className = 'floating-text';
        floatingText.textContent = text;
        floatingText.style.color = color;
        floatingText.style.left = `${x}px`;
        floatingText.style.top = `${y}px`;
        
        document.body.appendChild(floatingText);
        
        setTimeout(() => {
            floatingText.remove();
        }, 1500);
    }

    // =============================
    // Notification System
    // =============================
    function showNotification(message, className = '') {
        if (!gameState.notificationsEnabled) return;
        
        const notification = document.createElement('div');
        notification.className = `notification ${className}`;
        notification.textContent = message;
        
        document.getElementById('notification-container').appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, CONFIG.NOTIFICATION_DURATION);
    }

    function showSaveNotification() {
        if (!gameState.notificationsEnabled) return;
        
        const saveNotification = document.getElementById('save-notification');
        saveNotification.style.opacity = '1';
        
        setTimeout(() => {
            saveNotification.style.opacity = '0';
        }, 2000);
    }

    // =============================
    // Modal Functions
    // =============================
    function toggleModal(modal) {
        modal.classList.toggle('active');
    }

    // =============================
    // Settings Functions
    // =============================
    function toggleNotifications(e) {
        gameState.notificationsEnabled = e.target.checked;
        saveGame();
    }

    function toggleAnimations(e) {
        gameState.animationsEnabled = e.target.checked;
        saveGame();
        
        if (!gameState.animationsEnabled) {
            document.querySelectorAll('.golden-cookie, .floating-text, .milk-bubble').forEach(el => el.remove());
        } else {
            createMilkBubbles();
        }
    }

    function toggleOfflineProgress(e) {
        gameState.offlineProgressEnabled = e.target.checked;
        gameState.lastOfflineTime = Date.now();
        saveGame();
    }

    function manualSave() {
        saveGame();
        showSaveNotification();
        showNotification('Game saved successfully!');
    }

    function manualLoad() {
        loadGame();
        showNotification('Game loaded successfully!');
        updateUI();
    }

    function exportSave() {
        const saveData = btoa(JSON.stringify(getSaveData()));
        const blob = new Blob([saveData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `cookie_clicker_save_${Date.now()}.txt`;
        a.click();
        
        URL.revokeObjectURL(url);
        showNotification('Save exported successfully!');
    }

    function importSave() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.txt';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const saveData = JSON.parse(atob(event.target.result));
                    loadSaveData(saveData);
                    showNotification('Save imported successfully!');
                    updateUI();
                } catch (error) {
                    showNotification('Error importing save file!');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }

    function hardReset() {
        if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
            localStorage.removeItem('cookieClickerSave');
            window.location.reload();
        }
    }

    // =============================
    // Save/Load System
    // =============================
    function getSaveData() {
        return {
            cookies: gameState.cookies,
            totalCookiesEarned: gameState.totalCookiesEarned,
            clickPower: gameState.clickPower,
            totalClicks: gameState.totalClicks,
            goldenCookiesClicked: gameState.goldenCookiesClicked,
            playTime: gameState.playTime,
            heavenlyChips: gameState.heavenlyChips,
            prestigePoints: gameState.prestigePoints,
            prestigeCount: gameState.prestigeCount,
            isFrenzyActive: gameState.isFrenzyActive,
            frenzyTimeLeft: gameState.frenzyTimeLeft,
            lastOfflineTime: gameState.lastOfflineTime,
            notificationsEnabled: gameState.notificationsEnabled,
            animationsEnabled: gameState.animationsEnabled,
            offlineProgressEnabled: gameState.offlineProgressEnabled,
            version: CONFIG.VERSION,
            buildings: buildings.map(b => ({ 
                id: b.id, 
                count: b.count, 
                unlocked: b.unlocked,
                cpsMultiplier: b.cpsMultiplier 
            })),
            upgrades: upgrades.map(u => ({ 
                id: u.id, 
                bought: u.bought 
            })),
            prestigeUpgrades: prestigeUpgrades.map(pu => ({ 
                id: pu.id, 
                bought: pu.bought 
            })),
            achievements: achievements.map(a => ({ 
                id: a.id, 
                unlocked: a.unlocked 
            }))
        };
    }

    function loadSaveData(saveData) {
        // Basic game state
        gameState.cookies = saveData.cookies || 0;
        gameState.totalCookiesEarned = saveData.totalCookiesEarned || 0;
        gameState.clickPower = saveData.clickPower || 1;
        gameState.totalClicks = saveData.totalClicks || 0;
        gameState.goldenCookiesClicked = saveData.goldenCookiesClicked || 0;
        gameState.playTime = saveData.playTime || 0;
        gameState.heavenlyChips = saveData.heavenlyChips || 0;
        gameState.prestigePoints = saveData.prestigePoints || 0;
        gameState.prestigeCount = saveData.prestigeCount || 0;
        gameState.isFrenzyActive = saveData.isFrenzyActive || false;
        gameState.frenzyTimeLeft = saveData.frenzyTimeLeft || 0;
        gameState.lastOfflineTime = saveData.lastOfflineTime || Date.now();
        gameState.notificationsEnabled = saveData.notificationsEnabled !== undefined ? saveData.notificationsEnabled : true;
        gameState.animationsEnabled = saveData.animationsEnabled !== undefined ? saveData.animationsEnabled : true;
        gameState.offlineProgressEnabled = saveData.offlineProgressEnabled !== undefined ? saveData.offlineProgressEnabled : true;
        
        // Buildings
        if (saveData.buildings) {
            saveData.buildings.forEach(savedBuilding => {
                const building = buildings.find(b => b.id === savedBuilding.id);
                if (building) {
                    building.count = savedBuilding.count || 0;
                    building.unlocked = savedBuilding.unlocked || false;
                    building.cpsMultiplier = savedBuilding.cpsMultiplier || 1;
                }
            });
        }
        
        // Upgrades
        if (saveData.upgrades) {
            saveData.upgrades.forEach(savedUpgrade => {
                const upgrade = upgrades.find(u => u.id === savedUpgrade.id);
                if (upgrade) {
                    upgrade.bought = savedUpgrade.bought || false;
                }
            });
        }
        
        // Prestige Upgrades
        if (saveData.prestigeUpgrades) {
            saveData.prestigeUpgrades.forEach(savedPrestigeUpgrade => {
                const prestigeUpgrade = prestigeUpgrades.find(pu => pu.id === savedPrestigeUpgrade.id);
                if (prestigeUpgrade) {
                    prestigeUpgrade.bought = savedPrestigeUpgrade.bought || false;
                }
            });
        }
        
        // Achievements
        if (saveData.achievements) {
            saveData.achievements.forEach(savedAchievement => {
                const achievement = achievements.find(a => a.id === savedAchievement.id);
                if (achievement) {
                    achievement.unlocked = savedAchievement.unlocked || false;
                }
            });
        }
        
        calculateCPS();
    }

    function saveGame() {
        try {
            localStorage.setItem('cookieClickerSave', JSON.stringify(getSaveData()));
            gameState.lastSave = Date.now();
        } catch (error) {
            console.error('Error saving game:', error);
        }
    }

    function loadGame() {
        try {
            const data = localStorage.getItem('cookieClickerSave');
            if (data) {
                const saveData = JSON.parse(data);
                loadSaveData(saveData);
            }
        } catch (error) {
            console.error('Error loading game:', error);
        }
    }

    // =============================
    // Game Loop
    // =============================
    function startGameLoop() {
        let lastTime = Date.now();
        
        function gameLoop() {
            const currentTime = Date.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            // Update cookies based on CPS and delta time
            gameState.cookies += gameState.cps * deltaTime;
            gameState.totalCookiesEarned += gameState.cps * deltaTime;
            gameState.playTime += deltaTime;
            
            // Update frenzy timer
            if (gameState.isFrenzyActive) {
                gameState.frenzyTimeLeft -= deltaTime;
                if (gameState.frenzyTimeLeft <= 0) {
                    gameState.isFrenzyActive = false;
                    cookieEl.classList.remove('frenzy-active');
                    calculateCPS();
                }
            }
            
            // Random golden cookie spawn
            if (Math.random() < CONFIG.GOLDEN_COOKIE_CHANCE * deltaTime) {
                spawnGoldenCookie();
            }
            
            // Update UI with throttling
            if (currentTime - gameState.lastUpdate > 100) {
                updateUI();
                gameState.lastUpdate = currentTime;
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Auto-save interval
        setInterval(() => {
            saveGame();
            showSaveNotification();
        }, CONFIG.SAVE_INTERVAL);
        
        // Start the game loop
        requestAnimationFrame(gameLoop);
    }

    // =============================
    // Start the Game
    // =============================
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
